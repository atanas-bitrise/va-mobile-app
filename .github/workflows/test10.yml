
# test build

name: '[test] testing'

on:
  push:
    branches:
        - chanel-6808-create-system-for-updating-names-on-release-tickets

jobs:

  release_ticket:
    runs-on: ubuntu-latest
    outputs:
      ticketNumber: ${{steps.create-issue.outputs.number}}
      versionNumber: ${{env.VERSION}}
      releaseDate: ${{env.RELEASE_DATE}}
      qaDueDate: ${{env.QA_DUE_DATE}}
      prodDueDate: ${{env.PROD_DUE_DATE}}
      vaDueDate: ${{env.VA_DUE_DATE}}
    steps:
      - run: echo "VERSION=${GITHUB_REF##*/}" >> $GITHUB_ENV
      - run: echo "QA_DUE_DATE=$(date -d "+2 days" '+%A %b %d, %Y')" >> $GITHUB_ENV
      - run: echo "PROD_DUE_DATE=$(date -d "+5 days" '+%A %b %d, %Y')" >> $GITHUB_ENV
      - run: echo "VA_DUE_DATE=$(date -d "+6 days" '+%A %b %d, %Y')" >> $GITHUB_ENV
      - run: echo "RELEASE_DATE=$(date -d "+13 days" '+%A %b %d, %Y')" >> $GITHUB_ENV
      - uses: actions/checkout@v3
      - run: echo "${{ secrets.GH_ACTIONS_PAT }}" > token.txt
      - run: gh auth login --with-token < token.txt
      - name: Create Release Ticket and Assign Team Members
        run: |
          # Create the release ticket and capture its issue number
          ISSUE_NUMBER=$(gh issue create --title "Release Ticket" --body "Generated release ticket" --json number --jq '.number')

          # Add team members as assignees to the created release ticket
          gh issue edit "$ISSUE_NUMBER" $(gh api orgs/department-of-veterans-affairs/teams/flagship-mobile-release-approvers/members --jq 'map("--add-assignee " + .login) | join(" ")')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
