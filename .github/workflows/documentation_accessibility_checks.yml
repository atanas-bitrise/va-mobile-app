name: '[Documentation] Accessibility Check'

# Adapted from https://docusaurus.io/docs/deployment

on:
  workflow_dispatch:
  push:
    branches:
      - chanel-8217-accessibility-checks
    # paths: 
    #   - VAMobile/src/components/**
    #   - VAMobile/documentation/**
    #   - VAMobile/src/utils/hooks.tsx

jobs:
  test-deploy:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      # Step 1: Clean npm cache
      - name: Clean npm cache
        run: npm cache clean --force

      # Step 2: Install Axe CLI globally
      - name: Install Axe CLI globally
        run: npm install -g @axe-core/cli@latest

      # Step 3: Update npm
      - name: Update npm
        run: npm install -g npm@latest

  
      # Step 4: Setup Node.js environment  
      - uses: actions/setup-node@v3
        with:
          node-version-file: 'VAMobile/.nvmrc'
          cache: yarn
          cache-dependency-path: VAMobile/yarn.lock

      # Step 5: Install dependencies and build     
      - name: Test build
        working-directory: VAMobile
        run: |
          yarn install --frozen-lockfile
          cd documentation
          yarn install --frozen-lockfile
          yarn build

      # Step 6: Start web server
      - name: Start web server
        working-directory: VAMobile/documentation
        run: npm start & npx wait-on http://localhost:3000 &


     # - name: Run accessibility check on single URL
     #   run: axe https://department-of-veterans-affairs.github.io/va-mobile-app/docs/Intro --exit 

      - name: Check accessibility issues
        run: axe https://department-of-veterans-affairs.github.io/va-mobile-app/docs/Intro --exit || echo "::set-output name=accessibility_issues::true"

      - name: Notify about accessibility issues
        if: steps.check_accessibility_issues.outputs.accessibility_issues == 'true'
        run: |
          echo "Accessibility issues were detected during the first run of the accessibility check. Please review and address them." | mail -s "Accessibility Issues Detected" charnelle.domguia@adhocteam.com


 # start_slack_thread:
   #     name: Start Slack thread
      #  needs: test-deploy
       #uses: ./.github/workflows/start_slack_thread.yml
      #  secrets: inherit
       # with:
        #  channel_name: va-mobile-build-alerts
       #  # message: 'On demand build started by {{ github.actor }}: \"{{ inputs.notes }}\"  (:git: `{{ github.ref_name }}`). This process may take a while. See :thread: or <{{ github.server_url }}/{{ github.repository }}/actions/runs/{{ github.run_id }}|workflow run> for results.'
              